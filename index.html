<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåˆ·é¢˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .state-part {
            padding: 10px 20px;
            text-align: right;
            background: #f5f5f5;
            
        }
        
        .main-container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        .question-part {
            overflow: auto;
        }
        
        .question-list {
            width: 250px;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
        }
        
        .question-item {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .question-item:hover {
            background: #e0e0e0;
        }
        
        .question-item.active {
            background: #e3f2fd;
            border-left: 4px solid #1976D2;
        }
        
        .status-tag {
            min-width: 12px;
            border-radius: 2px;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .answered {
            background: #1890ff;
            font-size: 10px;
            color: #fff;
            padding: 2px 3px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .question-container {
            padding: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            position: relative;
            min-height: 48px;
        }
        
        .answer-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        
        .submit-answer {
            padding: 8px 15px;
            background: #1976D2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .submit-answer:hover {
            background: #1565C0;
        }
        .answer-actions {
            display: flex;
            flex-direction: column;
        }
        
        .control-btn {
            flex: 1;
            padding: 8px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            margin-right: 10px;
        }
        
        .refresh-btn {
            background: #FF9800;
        }

        .summary-btn {
            background-color: #ddd;
            cursor: not-allowed;
            color: #cccccc;
            min-width: 100px;
        }
        
        .refresh-btn:hover {
            background: #F57C00;
        }

        /* æ·»åŠ å¾…å­¦ä¹ æ¸…å•æŒ‰é’®æ ·å¼ */
        .add-to-learn-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            right: 5px;
            top: 5px;
        }
        
        .add-to-learn-btn:hover {
            background: #388E3C;
        }
        
        .learn-list-btn {
            background: #2196F3;
        }
        
        .learn-list-btn:hover {
            background: #1976D2;
        }
        
        /* å¾…å­¦ä¹ æ¸…å•å¼¹çª—æ ·å¼ */
        .learn-list-modal {
            width: 700px;
            max-width: 90vw;
        }
        
        .learn-list-item {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: column;
        }
        
        .learn-list-item-content {
            flex: 1;
            cursor: pointer;
            background: #e0e0e0;
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            margin-top: 5px;
        }

        .learn-list-container {
            height: 62vh;
            overflow: auto;
        }
        
        .remove-learn-btn {
            background: #f44336;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
        }
        
        .remove-learn-btn:hover {
            background: #d32f2f;
        }
        
        .learn-item-detail {
            padding: 10px;
            background: #f5f5f5;
            display: none;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        /* æ·»åŠ å¼¹æ¡†ç›¸å…³æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            cursor: pointer;
            font-size: 20px;
        }

        .question-type-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .form-item {
            display: flex;
            align-items: center;
        }

        .form-item label {
            flex: 1;
        }

        .form-item input {
            width: 60px;
            padding: 4px;
            margin-left: 10px;
            border: 1px solid #cccccc;
            border-radius: 4px;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }

        .toast {
            position: fixed;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            z-index: 1001;
            white-space: nowrap;
        }

        .add-custom-type {
            grid-column: span 2;
            padding: 10px 0;
            border-top: 1px solid #eee;
            margin-top: 10px;
        }

        .custom-type-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .custom-type-input input[type="text"] {
            flex: 1;
            padding: 4px;
            border: 1px solid #cccccc;
            border-radius: 4px;
        }

        .custom-type-input input[type="number"] {
            width: 60px;
            padding: 4px;
            border: 1px solid #cccccc;
            border-radius: 4px;
        }

        .custom-type-input .delete-btn {
            color: #ff4d4f;
            cursor: pointer;
            padding: 4px 8px;
        }

        .add-type-btn {
            color: #1890ff;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .key-input-form input {
            width: 100%;
            height: 34px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .loading-text {
            padding-left: 16px;
            font-size: 16px;
            font-weight: 500;
            color: #3498db;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="state-part">
            <div class="control-panel">
                <button class="control-btn refresh-btn">æ¢ä¸€æ‰¹é¢˜ç›®</button>
                <button class="control-btn learn-list-btn">å¾…å­¦ä¹ æ¸…å•</button>
                <!-- TODO: æœ¬æ¬¡é˜…å·æ•´ä½“æƒ…å†µåˆ†æ -->
                <button class="control-btn summary-btn" disabled>ç”Ÿæˆæ€»ç»“(å¾…å®ç°)</button>
            </div>
        </div>
        <div class="main-container">
            <div class="question-part">
                <div class="question-list"></div>
            </div>
            <div class="main-content">
                <div class="question-container">
                    <button class="add-to-learn-btn">æ·»åŠ åˆ°å¾…å­¦ä¹ æ¸…å•</button>
                    <div class="question-content">
                        <!-- é¢˜ç›®å†…å®¹ -->
                    </div>
                </div>
                <div class="answer-area">
                    <textarea placeholder="è¯·åœ¨æ­¤è¾“å…¥ä½ çš„ä½œç­”..."></textarea>
                    <div class="answer-actions">
                        <button class="submit-answer">æäº¤AIé˜…å·</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¼¹æ¡†å’Œtoastç»„ä»¶ -->
    <div class="modal-overlay">
        <div class="modal key-start" style="display: none;">
            <div class="modal-header">
                <h3>æ£€æµ‹åˆ°æœ¬åœ°å·²ä¿å­˜api_key,æ˜¯å¦ç›´æ¥å¼€å§‹ç­”é¢˜ï¼Ÿ</h3>
            </div>
            <div class="modal-footer">
                <button class="control-btn refresh-btn" id="startKey">å¼€å§‹ç­”é¢˜</button>
            </div>
        </div>
        <!-- æ·»åŠ å¯†é’¥éªŒè¯å¼¹æ¡† -->
        <div class="modal key-verification" style="display: none;">
            <div class="modal-header">
                <h3>è¾“å…¥deepseekçš„api_key</h3>
            </div>
            <div class="key-input-form">
                <input type="password" id="keyInput" placeholder="è¾“å…¥deepseek(å› ä¸ºä»–ä¾¿å®œ)api_keyï¼Œå…¶ä»–å¹³å°æ¥å£è¯·è‡ªå·±copyç½‘é¡µæ”¹ä»£ç ">
                <div class="error-message" style="color: red; display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="control-btn refresh-btn" id="verifyKey">ç¡®è®¤</button>
            </div>
        </div>
        <div class="modal question-settings" style="display: none;">
            <div class="modal-header">
                <h3>è®¾ç½®é¢˜ç›®æ•°é‡</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="question-type-form">
                <div class="form-item">
                    <label>HTML</label>
                    <input type="number" name="html" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>CSS</label>
                    <input type="number" name="css" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>JavaScript</label>
                    <input type="number" name="javascript" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>TypeScript</label>
                    <input type="number" name="typescript" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>Vue</label>
                    <input type="number" name="vue3" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>React</label>
                    <input type="number" name="react" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>Webpack</label>
                    <input type="number" name="webpack" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>Git</label>
                    <input type="number" name="gulp" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>æ€§èƒ½ä¼˜åŒ–</label>
                    <input type="number" name="performance" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>å¾®æœåŠ¡</label>
                    <input type="number" name="microservice" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>NodeJS</label>
                    <input type="number" name="nodejs" min="0" value="0">
                </div>
                <div class="form-item">
                    <label>ç®—æ³•</label>
                    <input type="number" name="algorithm" min="0" value="0">
                </div>
                
                <!-- æ·»åŠ è‡ªå®šä¹‰é¢˜å‹éƒ¨åˆ† -->
                <div class="add-custom-type">
                    <div id="customTypes"></div>
                    <span class="add-type-btn" onclick="addCustomType()">
                        <span>+</span> æ·»åŠ è‡ªå®šä¹‰é¢˜å‹
                    </span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="control-btn refresh-btn" id="confirmQuestions">ç¡®è®¤</button>
            </div>
        </div>
        <!-- æ·»åŠ å¾…å­¦ä¹ æ¸…å•å¼¹çª— -->
        <div class="modal learn-list-modal" style="display: none;">
            <div class="modal-header">
                <h3>å¾…å­¦ä¹ æ¸…å•</h3>
            </div>
            <div class="learn-list-container">
                <!-- å¾…å­¦ä¹ æ¸…å•å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="modal-footer">
                <button class="control-btn refresh-btn" id="closeLearnList">å…³é—­</button>
            </div>
        </div>
    </div>
    <div class="toast"></div>

    <!-- æ·»åŠ loadingé®ç½© -->
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ¥å£è°ƒç”¨æ¯”è¾ƒæ…¢(è·å–é¢˜ç›®å¤§æ¦‚éœ€è¦1min,é˜…å·å¤§æ¦‚20s)ï¼Œä¸è¦ç€æ€¥ï½</div>
    </div>

    <script>
        // æ¨¡æ‹Ÿé¢˜ç›®æ•°æ®
        const questions = [];

        function handleLtGt(str) {
            return str.replace(/</g, '&lt;').replace(/>/g, '&gt;')
        }

        const questionList = document.querySelector('.question-list');
        const questionContent = document.querySelector('.question-content');
        const textarea = document.querySelector('textarea');
        const submitAnswerBtn = document.querySelector('.submit-answer');
        let currentQuestion = null;

        const refreshBtn = document.querySelector('.refresh-btn');

        const STORAGE_KEY = 'questionTypeSettings';
        const CUSTOM_TYPES_KEY = 'customQuestionTypes';
        let customTypes = [];

        const loadingOverlay = document.querySelector('.loading-overlay');

        // æ·»åŠ è‡ªå®šä¹‰é¢˜å‹
        function addCustomType(name = '', num = 0) {
            const customTypesContainer = document.getElementById('customTypes');
            const typeDiv = document.createElement('div');
            typeDiv.className = 'custom-type-input';
            typeDiv.innerHTML = `
                <input type="text" placeholder="è¾“å…¥é¢˜å‹åç§°" value="${name}" class="custom-type-name">
                <input type="number" min="0" value="${num}" class="custom-type-num">
                <span class="delete-btn" onclick="deleteCustomType(this)">Ã—</span>
            `;
            customTypesContainer.appendChild(typeDiv);
        }

        // åˆ é™¤è‡ªå®šä¹‰é¢˜å‹
        function deleteCustomType(element) {
            element.parentElement.remove();
        }


        // å¤„ç†æ•°æ®å¼‚å¸¸
        function replaceOther(str) {
            return str.replace(/```json|```|\n|#/g, '')
        }

        // ä»localStorageåŠ è½½é¢˜å‹è®¾ç½®
        function loadQuestionTypeSettings() {
            // åŠ è½½é¢„è®¾é¢˜å‹è®¾ç½®
            const settings = localStorage.getItem(STORAGE_KEY);
            if (settings) {
                const savedSettings = JSON.parse(settings);
                document.querySelectorAll('.question-type-form input').forEach(input => {
                    if (savedSettings.some(one => one.type === input.name)?.length) {
                        input.value = savedSettings.some(one => one.type === input.name)[0].type;
                    }
                });
            }

            // åŠ è½½è‡ªå®šä¹‰é¢˜å‹
            const savedCustomTypes = localStorage.getItem(CUSTOM_TYPES_KEY);
            if (savedCustomTypes) {
                customTypes = JSON.parse(savedCustomTypes);
                customTypes.forEach(type => {
                    addCustomType(type.name, type.num);
                });
            }
        }

        // ä¿å­˜é¢˜å‹è®¾ç½®åˆ°localStorage
        function saveQuestionTypeSettings() {
            // ä¿å­˜é¢„è®¾é¢˜å‹è®¾ç½®
            const settings = [];
            document.querySelectorAll('.question-type-form input[name]').forEach(input => {
                settings.push({type: input.name, num: input.value || 0});
            }); 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));

            // ä¿å­˜è‡ªå®šä¹‰é¢˜å‹
            customTypes = [];
            document.querySelectorAll('.custom-type-input').forEach(div => {
                const type = div.querySelector('.custom-type-name').value.trim();
                const num = parseInt(div.querySelector('.custom-type-num').value) || 0;
                if (type) {
                    customTypes.push({ type, num });
                }
            });
            localStorage.setItem(CUSTOM_TYPES_KEY, JSON.stringify(customTypes));
        }

        // æ¸²æŸ“é¢˜ç›®åˆ—è¡¨
        function renderQuestionList() {
            questionList.innerHTML = questions.map(q => `
                <div class="question-item" data-id="${q.id}">
                    <div>ç¬¬${q.id}é¢˜ï¼š${q.title}</div>
                <div class="status-tag ${q.answered && !q.checked ? 'answered' : ''}">${q.checked ? (new Array(q.score).fill('ğŸŒŸ').join('')) : (q.answered ? 'å¾…æäº¤' : '')}</div>
                </div>
            `).join('');
        }

        function renderQuestion(q) {
            const question = document.querySelector(`.question-item[data-id="${q.id}"]`)
            question.innerHTML = `
                <div>ç¬¬${q.id}é¢˜ï¼š${q.title}</div>
                <div class="status-tag ${q.answered && !q.checked ? 'answered' : ''}">${q.checked ? (new Array(q.score).fill('ğŸŒŸ').join('')) : (q.answered ? 'å¾…æäº¤' : '')}</div>
            `
        }

        // æ˜¾ç¤ºå½“å‰é¢˜ç›®
        function showQuestion(question) {
            if (!question) return;
            currentQuestion = question;
            questionContent.innerHTML = `<h3>ç¬¬${question.id}é¢˜ï¼š${question.title}</h3><p>${question.content}</p>${question.checked ? `<br /><h3>AIé˜…å·ç»“æœ â€”â€”ã€è¯„åˆ† ${new Array(question.score).fill('ğŸŒŸ').join('')}ã€‘</h3><p>${question.check}</p>` : ''}`;
            textarea.value = question.answer || '';
            
            // æ›´æ–°é«˜äº®çŠ¶æ€
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.id) === question.id) {
                    item.classList.add('active');
                }
            });
        }

        // äº‹ä»¶ç›‘å¬
        questionList.addEventListener('click', (e) => {
            const item = e.target.closest('.question-item');
            if (item) {
                // ä¿å­˜å½“å‰ç­”æ¡ˆ
                if (currentQuestion) {
                    currentQuestion.answer = textarea.value;
                    if (currentQuestion.answer) {
                        currentQuestion.answered = true
                        renderQuestion(currentQuestion)
                    }
                }
                
                const id = parseInt(item.dataset.id);
                const question = questions.find(q => q.id === id);
                showQuestion(question);
            }
        });

        function handleRequestBody(prompt, json) {
            const obj = {
                "model": "deepseek-chat",
                "messages": [
                    {"role": "system", "content": prompt},
                    {"role": "user", "content": json}
                ],
                "response_format": {"type": "json_object"},
                "stream": false
            }
            return obj
        }

        // æ˜¾ç¤º/éšè—loadingçš„å‡½æ•°
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // ä¿®æ”¹æäº¤ç­”æ¡ˆçš„å¤„ç†é€»è¾‘
        submitAnswerBtn.addEventListener('click', async () => {
            const answerContent = textarea.value.trim();
            
            if (!answerContent) {
                showToast('è¯·è¾“å…¥ç­”æ¡ˆ');
                return;
            }

            showLoading(); // æ˜¾ç¤ºloading
            const requestbody = handleRequestBody(
                `ä½ æ˜¯ä¸€ä¸ªå®¢è§‚å…¬æ­£ã€æŠ€æœ¯èƒ½åŠ›è¶…å¼ºä½†è¯­æ°”æ¸©å’Œçš„é¢è¯•è€ƒæ ¸å®˜ã€‚å¯¹æ–¹æ˜¯ä¸€ä¸ªå®¶å¢ƒè´«è‹¦è‡ªå¼ºä¸æ¯è™½ç„¶æœ‰ç‚¹æ„šç¬¨ä½†æ˜¯å¾ˆåŠªåŠ›çš„å¯æ€œé¢è¯•è€…ã€‚è¯·å¯¹å¯¹æ–¹çš„é¢è¯•å›ç­”åšä¸€ä¸ªæ•´ä½“è¯„ä»·å’Œè¯„åˆ†ï¼ŒæŒ‡å‡ºå‡ºé¢˜çš„æ ¸å¿ƒè€ƒç‚¹ï¼Œå¯¹äºç­”å¯¹çš„å†…å®¹ç»™äºˆè‚¯å®šï¼Œå¹¶æŒ‡å‡ºå›ç­”ä¸­å¯ä»¥æ”¹è¿›çš„éƒ¨åˆ†ã€‚å›å¤æ ¼å¼åªèƒ½æŒ‰ç…§ç»™å‡ºçš„ç¤ºä¾‹ç»“æ„è¿”å›ã€‚EXAMPLE JSON OUTPUT: { "score": 0, "comment": "è¯„è¯­å†…å®¹"}ã€‚å…¶ä¸­scoreå–å€¼èŒƒå›´ä¸º0-5ï¼ˆå‡†ç¡®ç‡é‡80%ï¼Œè¡¨è¾¾æ¸…æ™°åº¦æƒé‡20%ï¼‰ï¼Œcommentè¿”å›å†…å®¹ä¸­ä¸è¦å‡ºç°åç§°è¯æ±‡ã€‚`,
                `å¯¹äºæ‚¨ç»™å‡ºçš„é—®é¢˜ã€${currentQuestion.content}ã€‘,æˆ‘çš„å›ç­”æ˜¯ã€${answerContent}ã€‘ã€‚è¯·æ‚¨å¯¹æˆ‘çš„æé—®ç»™äºˆè¯„ä»·ã€‚`
            )

            const savedKey = localStorage.getItem(KEY_STORAGE);
            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + savedKey
                    },
                    body: JSON.stringify(requestbody)
                });

                if (!response.ok) {
                    throw new Error('é˜…å·å¤±è´¥');
                }

                const result = await response.json();
                // å¤„ç†é˜…å·ç»“æœ
                currentQuestion.answered = true;
                currentQuestion.answer = answerContent;
                try {
                    const res = JSON.parse(replaceOther(result.choices[0].message.content))
                    currentQuestion.checked = true;
                    currentQuestion.check = handleLtGt(res.comment);
                    currentQuestion.score = res.score;
                    // æ›´æ–°UIæ˜¾ç¤º
                    showToast('é˜…å·å®Œæˆ');
                } catch (e) {
                    showToast('é˜…å·å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                }
            } catch (error) {
                console.error('é˜…å·å¤±è´¥:', error);
                showToast('é˜…å·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                hideLoading();
                renderQuestion(currentQuestion);
                showQuestion(currentQuestion);
            }
        });

        // ä¿®æ”¹è·å–æ–°é¢˜ç›®çš„ç›¸å…³ä»£ç 
        const modal = document.querySelector('.modal-overlay');
        const modalClose = document.querySelector('.modal-close');
        const toast = document.querySelector('.toast');
        const confirmBtn = document.getElementById('confirmQuestions');

        // æ˜¾ç¤ºtoastæç¤º
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        // ä¿®æ”¹æ‰“å¼€å¼¹æ¡†çš„äº‹ä»¶å¤„ç†
        refreshBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
            startPracticeModal.style.display = 'none'
            keyVerificationModal.style.display = 'none';
            questionSettingsModal.style.display = 'block';
            loadQuestionTypeSettings(); // åŠ è½½ä¸Šæ¬¡çš„è®¾ç½®
        });

        // å…³é—­å¼¹æ¡†
        modalClose.addEventListener('click', () => {
            modal.style.display = 'none';
            startPracticeModal.style.display = 'none'
            keyVerificationModal.style.display = 'none';
            questionSettingsModal.style.display = 'none';
        });

        // æ·»åŠ å¯†é’¥éªŒè¯ç›¸å…³ä»£ç 
        const KEY_STORAGE = 'interview_key';
        const keyVerificationModal = document.querySelector('.key-verification');
        const startPracticeModal = document.querySelector('.key-start');
        const questionSettingsModal = document.querySelector('.question-settings');
        const keyInput = document.getElementById('keyInput');
        const verifyKeyBtn = document.getElementById('verifyKey');
        const startBtn = document.getElementById('startKey');
        const errorMessage = document.querySelector('.error-message');
        const defaultTypes = [{type: 'html', num: 2}]

        function getAllType() {
            let localTypes = [];
            let customTypes = [];
            try {
                localTypes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []
            } catch(e) {}
            try {
                customTypes = JSON.parse(localStorage.getItem(CUSTOM_TYPES_KEY)) || []
            } catch(e) {}
            const questionTypes =  localTypes.concat(customTypes)?.length > 0 ? localTypes.concat(customTypes) : defaultTypes;
            return questionTypes
        }

        // ä¿®æ”¹ç¡®è®¤æŒ‰é’®çš„äº‹ä»¶å¤„ç†
        confirmBtn.addEventListener('click', () => {
            const inputs = [...document.querySelectorAll('.question-type-form input[name]'), 
                           ...document.querySelectorAll('.custom-type-input input[type="number"]')];
            let total = 0;
            const questionTypes = [];

            // æ”¶é›†æ‰€æœ‰è¾“å…¥å€¼å¹¶éªŒè¯
            inputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value < 0) {
                    showToast('é¢˜ç›®æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°');
                    return;
                }
                total += value;
            });

            if (total > 50) {
                showToast('é¢˜ç›®æ€»æ•°ä¸èƒ½è¶…è¿‡50é“');
                return;
            }

            if (total === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€é“é¢˜ç›®');
                return;
            }

            // æ”¶é›†é¢„è®¾é¢˜å‹
            document.querySelectorAll('.question-type-form input[name]').forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value > 0) {
                    questionTypes.push({
                        type: input.name,
                        num: value
                    });
                }
            });

            // æ”¶é›†è‡ªå®šä¹‰é¢˜å‹
            document.querySelectorAll('.custom-type-input').forEach(div => {
                const name = div.querySelector('.custom-type-name').value.trim();
                const num = parseInt(div.querySelector('.custom-type-num').value) || 0;
                if (name && num > 0) {
                    questionTypes.push({
                        type: name,
                        num: num
                    });
                }
            });

            // ä¿å­˜è®¾ç½®åˆ°localStorage
            saveQuestionTypeSettings();

            // è°ƒç”¨è·å–æ–°é¢˜ç›®çš„æ¥å£
            fetchNewQuestions(questionTypes);
        });

        // ä¿®æ”¹è·å–æ–°é¢˜ç›®çš„å‡½æ•°
        async function fetchNewQuestions(questionTypes) {
            showLoading(); // æ˜¾ç¤ºloading
            const requestbody = handleRequestBody(
                `ä½ æ˜¯ä¸€ä¸ªæ“…é•¿è®¾è®¡é¢è¯•é¢˜çš„å‰ç«¯é¢†åŸŸä¸“å®¶ã€‚ä½ è®¾è®¡çš„é¢è¯•é¢˜éå¸¸å…¨é¢ï¼Œä»åŸºç¡€åˆ°åŠ æ·±å‡æœ‰æ¶‰çŒã€‚ä½ æŸ¥é˜…è¿‡æˆåƒä¸Šä¸‡çš„å‰ç«¯é¢†åŸŸé¢è¯•é¢˜é¢˜åº“ï¼Œå‡ºé¢˜çš„è®¾è®¡æ€è·¯å›´ç»•ç€æŒ–æ˜ç­”é¢˜äººçš„æŠ€æœ¯æ°´å¹³ã€‚å‰ç«¯é¢†åŸŸå†…çš„æ¯ä¸ªæŠ€æœ¯æ–¹å‘ã€æ¯ä¸ªæ¡†æ¶ä½ éƒ½æœ‰æ¶‰çŒã€‚è¿”å›çš„æ•°æ®ç»“æ„ä¸åˆ†ç±»ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªå®Œæ•´çš„æ•°ç»„ç»“æ„ã€‚EXAMPLE JSON OUTPUTä¸ºï¼š[{ "title": "æ ‡é¢˜", "type": "ç±»å‹1", "content": "æè¿°" }, { "title": "æ ‡é¢˜", "type": "ç±»å‹2", "content": "æè¿°" }]ã€‚ å…¶ä¸­titleè¡¨è¾¾è¯¥é¢˜çš„æ ¸å¿ƒè€ƒç‚¹ï¼Œ typeä¸ºè®¾ç½®çš„é¢˜ç›®ç±»å‹ï¼Œcontentåˆ™æ˜¯é¢˜ç›®çš„å…·ä½“æè¿°ã€‚`,
                `ç°åœ¨éœ€è¦ç»™å‡ºä¸€ç»„å‰ç«¯é¢è¯•é¢˜ï¼ŒåŒ…å«${questionTypes.filter(one => one.num).map(one => `${one.type}ç±»å‹é¢˜ç›®${one.num}é“`).join('ã€')}ã€‚${questions?.length ? `ä½ å·²ç»å‡ºè¿‡è¿™äº›é¢˜ç›®ï¼š${questions.map(one => one.content).join('ã€')}ï¼Œè¯·é¿å…é¢˜ç›®é‡å¤å‡ºç°ã€‚` : ''}`
            );
            const savedKey = localStorage.getItem(KEY_STORAGE);
            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + savedKey,
                    },
                    body: JSON.stringify(requestbody)
                });
                
                if (response.status === 401) {
                    localStorage.removeItem(KEY_STORAGE);
                    keyInput.value = '';
                    errorMessage.textContent = 'æ— æ•ˆå¯†é’¥';
                    errorMessage.style.display = 'block';
                    modal.style.display = 'flex';
                    startPracticeModal.style.display = 'none'
                    keyVerificationModal.style.display = 'block';
                    questionSettingsModal.style.display = 'none';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('è·å–é¢˜ç›®å¤±è´¥');
                }

                const data = await response.json();
                
                const res = JSON.parse(replaceOther(data.choices[0].message.content))
                const list = res?.questions?.length ? res?.questions : res
                questions.length = 0;
                questions.push(...list.map((item, index) => ({
                    id: index + 1,
                    title: handleLtGt(item.title),
                    content: handleLtGt(item.content),
                    answered: false,
                    answer: ''
                })));
                renderQuestionList();
                showQuestion(questions[0]);
                modal.style.display = 'none';
                startPracticeModal.style.display = 'none'
                keyVerificationModal.style.display = 'none';
                questionSettingsModal.style.display = 'none';
            } catch (error) {
                console.error('è·å–é¢˜ç›®å¤±è´¥:', error);
                showToast('è·å–æ–°é¢˜ç›®å¤±è´¥');
            } finally {
                hideLoading();
            }
        }

        // åˆå§‹åŒ–éªŒè¯
        async function initializeApp() {
            const savedKey = localStorage.getItem(KEY_STORAGE);
            if (savedKey) {
                modal.style.display = 'flex';
                startPracticeModal.style.display = 'block'
                return;
            }
            
            // æ˜¾ç¤ºå¯†é’¥éªŒè¯å¼¹æ¡†
            modal.style.display = 'flex';
            keyVerificationModal.style.display = 'block';
            questionSettingsModal.style.display = 'none';
        }
        startBtn.addEventListener('click', async() => {
            showLoading();
            try {
                const questionTypes = getAllType()
                await fetchNewQuestions(questionTypes);
                renderQuestionList();
                showQuestion(questions[0]);
            } finally {
                hideLoading();
            }
        })

        // éªŒè¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        verifyKeyBtn.addEventListener('click', async () => {
            const key = keyInput.value.trim();
            if (!key) {
                errorMessage.textContent = 'è¯·è¾“å…¥å¯†é’¥';
                errorMessage.style.display = 'block';
                return;
            }
            
            localStorage.setItem(KEY_STORAGE, key);
            const questionTypes =  getAllType()
            await fetchNewQuestions(questionTypes);
        });

        // ä¿®æ”¹åŸæœ‰çš„åˆå§‹åŒ–è°ƒç”¨
        window.addEventListener('DOMContentLoaded', initializeApp);

        // æ·»åŠ å¾…å­¦ä¹ æ¸…å•ç›¸å…³å¸¸é‡å’Œå˜é‡
        const LEARN_LIST_KEY = 'learnListQuestions';
        const addToLearnBtn = document.querySelector('.add-to-learn-btn');
        const learnListBtn = document.querySelector('.learn-list-btn');
        const learnListModal = document.querySelector('.learn-list-modal');
        const learnListContainer = document.querySelector('.learn-list-container');
        const closeLearnListBtn = document.getElementById('closeLearnList');
        
        // ä»localStorageåŠ è½½å¾…å­¦ä¹ æ¸…å•
        function loadLearnList() {
            const learnList = localStorage.getItem(LEARN_LIST_KEY);
            return learnList ? JSON.parse(learnList) : [];
        }
        
        // ä¿å­˜å¾…å­¦ä¹ æ¸…å•åˆ°localStorage
        function saveLearnList(learnList) {
            localStorage.setItem(LEARN_LIST_KEY, JSON.stringify(learnList));
        }
        
        // æ·»åŠ é¢˜ç›®åˆ°å¾…å­¦ä¹ æ¸…å•
        function addToLearnList(question) {
            if (!question) return;
            
            const learnList = loadLearnList();
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒé¢˜ç›®
            const existingTypeIndex = learnList.findIndex(item => item.type === question.title.split('ï¼š')[0]);
            
            if (existingTypeIndex !== -1) {
                // æ£€æŸ¥è¯¥ç±»å‹ä¸‹æ˜¯å¦å·²å­˜åœ¨ç›¸åŒé¢˜ç›®
                const existingQuestionIndex = learnList[existingTypeIndex].questions.findIndex(
                    q => q.title === question.title && q.content === question.content
                );
                
                if (existingQuestionIndex === -1) {
                    // æ·»åŠ æ–°é¢˜ç›®åˆ°å·²å­˜åœ¨çš„ç±»å‹ä¸­
                    learnList[existingTypeIndex].questions.push({
                        title: question.title,
                        content: question.content
                    });
                } else {
                    showToast('è¯¥é¢˜ç›®å·²åœ¨å¾…å­¦ä¹ æ¸…å•ä¸­');
                    return;
                }
            } else {
                // æ·»åŠ æ–°ç±»å‹å’Œé¢˜ç›®
                learnList.push({
                    type: question.title.split('ï¼š')[0],
                    questions: [{
                        title: question.title,
                        content: question.content
                    }]
                });
            }
            
            saveLearnList(learnList);
            showToast('å·²æ·»åŠ åˆ°å¾…å­¦ä¹ æ¸…å•');
        }
        
        // ä»å¾…å­¦ä¹ æ¸…å•ä¸­ç§»é™¤é¢˜ç›®
        function removeFromLearnList(typeIndex, questionIndex) {
            const learnList = loadLearnList();
            
            if (learnList[typeIndex] && learnList[typeIndex].questions[questionIndex]) {
                learnList[typeIndex].questions.splice(questionIndex, 1);
                
                // å¦‚æœè¯¥ç±»å‹ä¸‹æ²¡æœ‰é¢˜ç›®äº†ï¼Œåˆ™ç§»é™¤è¯¥ç±»å‹
                if (learnList[typeIndex].questions.length === 0) {
                    learnList.splice(typeIndex, 1);
                }
                
                saveLearnList(learnList);
                showToast('å·²ä»å¾…å­¦ä¹ æ¸…å•ä¸­ç§»é™¤');
                renderLearnList();
            }
        }
        
        // æ¸²æŸ“å¾…å­¦ä¹ æ¸…å•
        function renderLearnList() {
            const learnList = loadLearnList();
            
            if (learnList.length === 0) {
                learnListContainer.innerHTML = '<p style="padding: 20px; text-align: center;">å¾…å­¦ä¹ æ¸…å•ä¸ºç©º</p>';
                return;
            }
            
            let html = '';
            
            learnList.forEach((typeItem, typeIndex) => {
                
                typeItem.questions.forEach((question, questionIndex) => {
                    html += `
                        <div class="learn-list-item">
                            <h4 class="learn-list-item-content" onclick="toggleLearnItemDetail(${typeIndex}, ${questionIndex})">
                                ${handleLtGt(question.title)}
                            </h4>
                            <div class="learn-item-detail" id="learn-detail-${typeIndex}-${questionIndex}">
                                <h4>é¢˜ç›®å†…å®¹ï¼š</h4>
                                <p>${handleLtGt(question.content)}</p>
                                <h4 style="margin-top: 10px;">ç›¸å…³çŸ¥è¯†ç‚¹ï¼š</h4>
                                <p>${typeItem.type}ç›¸å…³çŸ¥è¯†</p>
                                <button class="remove-learn-btn" onclick="removeFromLearnList(${typeIndex}, ${questionIndex})">
                                    ä»å­¦ä¹ æ¸…å•ä¸­ç§»é™¤
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
            
            learnListContainer.innerHTML = html;
        }
        
        // åˆ‡æ¢æ˜¾ç¤º/éšè—å¾…å­¦ä¹ é¢˜ç›®è¯¦æƒ…
        function toggleLearnItemDetail(typeIndex, questionIndex) {
            const detailElement = document.getElementById(`learn-detail-${typeIndex}-${questionIndex}`);
            if (detailElement) {
                detailElement.style.display = detailElement.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        // æ·»åŠ åˆ°å¾…å­¦ä¹ æ¸…å•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        addToLearnBtn.addEventListener('click', () => {
            if (currentQuestion) {
                addToLearnList(currentQuestion);
            } else {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€é“é¢˜ç›®');
            }
        });
        
        // æ˜¾ç¤ºå¾…å­¦ä¹ æ¸…å•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        learnListBtn.addEventListener('click', () => {
            renderLearnList();
            modal.style.display = 'flex';
            startPracticeModal.style.display = 'none';
            keyVerificationModal.style.display = 'none';
            questionSettingsModal.style.display = 'none';
            learnListModal.style.display = 'block';
        });
        
        // å…³é—­å¾…å­¦ä¹ æ¸…å•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        closeLearnListBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            learnListModal.style.display = 'none';
        });
        
        // ä¿®æ”¹å…³é—­å¼¹æ¡†äº‹ä»¶ï¼Œæ·»åŠ å¯¹å¾…å­¦ä¹ æ¸…å•å¼¹çª—çš„å¤„ç†
        modalClose.addEventListener('click', () => {
            modal.style.display = 'none';
            startPracticeModal.style.display = 'none';
            keyVerificationModal.style.display = 'none';
            questionSettingsModal.style.display = 'none';
            learnListModal.style.display = 'none';
        });
        
        // å°†toggleLearnItemDetailå‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.toggleLearnItemDetail = toggleLearnItemDetail;
        window.removeFromLearnList = removeFromLearnList;
    </script>
</body>
</html>